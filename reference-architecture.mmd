%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#29B5E8', 'primaryTextColor': '#fff', 'primaryBorderColor': '#1a8ab8', 'lineColor': '#6E7781', 'secondaryColor': '#11567F', 'tertiaryColor': '#F4F4F4', 'background': '#ffffff'}}}%%

flowchart TB
    subgraph FLOOR["<b>MANUFACTURING FLOOR</b>"]
        direction TB
        SENSORS["üîß PLCs / RTUs / Sensors<br/><i>Temperature, Vibration, Pressure, Current</i>"]
        HIVEMQ["<b>HiveMQ MQTT Broker</b><br/>‚Ä¢ QoS 1/2 Guaranteed Delivery<br/>‚Ä¢ TLS Encryption<br/>‚Ä¢ Clustered HA"]
        ASSETS["<b>Asset Types</b><br/>Furnaces ‚Ä¢ Conveyors ‚Ä¢ Presses<br/>Robots ‚Ä¢ Compressors ‚Ä¢ HVAC"]
        
        SENSORS --> HIVEMQ
        ASSETS -.-> SENSORS
    end

    subgraph SNOWFLAKE["<b>SNOWFLAKE DATA CLOUD</b>"]
        direction TB
        
        subgraph INGEST["<b>INGESTION LAYER</b>"]
            SNOWPIPE["Snowpipe Streaming<br/><i>Sub-second latency</i>"]
            RAW["TELEMETRY_RAW<br/><i>Landing Zone</i>"]
            SNOWPIPE --> RAW
        end

        subgraph BRONZE["<b>BRONZE LAYER</b> (Raw)"]
            TELBRONZE["TELEMETRY_BRONZE<br/>‚Ä¢ Raw sensor readings<br/>‚Ä¢ Device metadata<br/>‚Ä¢ Event & ingest timestamps"]
        end

        subgraph SILVER["<b>SILVER LAYER</b> (Curated)"]
            TELSILVER["TELEMETRY_SILVER<br/>‚Ä¢ Cleansed & validated<br/>‚Ä¢ Enriched with context<br/>‚Ä¢ Standardized formats"]
            REGISTRY["ASSET_REGISTRY<br/>‚Ä¢ Equipment hierarchy<br/>‚Ä¢ Maintenance history<br/>‚Ä¢ Criticality levels"]
        end

        subgraph GOLD["<b>GOLD LAYER</b> (Feature Store)"]
            FEATURES["ENTERPRISE_C_FEATURES<br/>‚Ä¢ Rolling aggregations (1h, 24h, 7d)<br/>‚Ä¢ Statistical features<br/>‚Ä¢ Trend indicators<br/>‚Ä¢ Cross-sensor correlations"]
        end

        subgraph ML["<b>SNOWPARK ML LAYER</b>"]
            TRAINING["Model Training<br/>XGBoost ‚Ä¢ Random Forest<br/>Gradient Boost ‚Ä¢ Deep Learning"]
            REGISTRY_ML["Model Registry<br/>Version Control<br/>Performance Logs"]
            INFERENCE["Inference Engine<br/>‚Ä¢ Real-time scoring<br/>‚Ä¢ Batch predictions<br/>‚Ä¢ Confidence intervals"]
            
            TRAINING --> REGISTRY_ML
            REGISTRY_ML --> INFERENCE
        end

        subgraph PREDICTIONS["<b>PREDICTIONS & RULES LAYER</b>"]
            PRED_TABLE["ASSET_PREDICTIONS<br/>‚Ä¢ Failure probabilities<br/>‚Ä¢ Failure modes<br/>‚Ä¢ RUL estimates<br/>‚Ä¢ SHAP values"]
            RULES["PREDICTIVE_RULES<br/>‚Ä¢ Alert thresholds<br/>‚Ä¢ Routing logic<br/>‚Ä¢ Work order templates"]
        end

        subgraph CORTEX["<b>CORTEX AI SERVICES</b>"]
            SEMANTIC["Semantic View<br/><b>PREDICTIVE_MAINTENANCE</b><br/>‚Ä¢ Table definitions<br/>‚Ä¢ Relationships<br/>‚Ä¢ Verified queries"]
            ANALYST["Cortex Analyst<br/>‚Ä¢ NLQ Interface<br/>‚Ä¢ SQL Generation<br/>‚Ä¢ Context-aware responses"]
            COMPLETE["Cortex Complete (LLM)<br/>‚Ä¢ 5-Why Analysis<br/>‚Ä¢ Root cause explanations<br/>‚Ä¢ Recommendations"]
            
            SEMANTIC --> ANALYST
            ANALYST --> COMPLETE
        end

        RAW --> TELBRONZE
        TELBRONZE --> TELSILVER
        REGISTRY -.-> TELSILVER
        TELSILVER --> FEATURES
        FEATURES --> TRAINING
        INFERENCE --> PRED_TABLE
        PRED_TABLE --> RULES
        PRED_TABLE --> SEMANTIC
    end

    subgraph SPCS["<b>SNOWPARK CONTAINER SERVICES</b>"]
        direction TB
        subgraph APP["<b>APPLICATION LAYER</b>"]
            REACT["React Frontend<br/>‚Ä¢ Dashboards<br/>‚Ä¢ Predictions<br/>‚Ä¢ NLQ Chat<br/>‚Ä¢ 5-Why Dialog"]
            FASTAPI["FastAPI Backend<br/>‚Ä¢ REST APIs<br/>‚Ä¢ Snowpark Queries<br/>‚Ä¢ Cortex Integration"]
            NGINX["NGINX Reverse Proxy<br/>SSL ‚Ä¢ Static Assets ‚Ä¢ Routing"]
            
            REACT <--> FASTAPI
            NGINX --> REACT
            NGINX --> FASTAPI
        end
        ENDPOINT["üåê Public Endpoint<br/><i>Snowflake-Managed SSL/TLS</i>"]
        NGINX --> ENDPOINT
    end

    subgraph USERS["<b>END USERS</b>"]
        direction LR
        TECH["üë∑ Maintenance<br/>Technicians"]
        OPS["üìä Operations<br/>Managers"]
        REL["‚öôÔ∏è Reliability<br/>Engineers"]
        EXEC["üìà Executive<br/>Leadership"]
    end

    HIVEMQ ==>|"MQTT/TLS"| SNOWPIPE
    CORTEX --> FASTAPI
    PRED_TABLE --> FASTAPI
    ENDPOINT --> USERS

    classDef floorStyle fill:#2E7D32,stroke:#1B5E20,color:#fff
    classDef snowflakeStyle fill:#29B5E8,stroke:#1a8ab8,color:#fff
    classDef layerStyle fill:#11567F,stroke:#0d4a6b,color:#fff
    classDef componentStyle fill:#E3F2FD,stroke:#1976D2,color:#1565C0
    classDef spcsStyle fill:#7B1FA2,stroke:#6A1B9A,color:#fff
    classDef userStyle fill:#F5F5F5,stroke:#9E9E9E,color:#424242

    class FLOOR floorStyle
    class SNOWFLAKE snowflakeStyle
    class SPCS spcsStyle
    class USERS userStyle
